flowchart TD
    %% --- Styles ---
    classDef rawData fill:#e1f7d5,stroke:#333;
    classDef graphData fill:#d5e8f7,stroke:#005f9e;
    classDef process fill:#fff0b3,stroke:#f39c12;

    %% --- Input ---
    subgraph Input ["1. Входные данные"]
        Ways[("osm.ways")]:::rawData
        Barriers[("osm.barriers")]:::rawData
    end

    %% --- Preprocessing ---
    subgraph Prep ["2. Препроцессинг"]
        Split["ST_Subdivide (Max 500m)"]:::process
        Filter["Разделение слоев (Ground vs Bridge)"]:::process
    end

    %% --- Core ---
    subgraph Core ["3. Грид-Нодинг (Grid Noding)"]
        Loop{{"Цикл по тайлам 0.05°"}}:::process
        Node["ST_Node (В памяти)"]:::process
        Snap["ST_SnapToGrid (1e-6)"]:::process
    end

    %% --- Synthesis ---
    subgraph Final ["4. Синтез графа"]
        Topo["pgr_createTopology"]:::process
        Attrib["Наследование атрибутов"]:::process
        Cost["Расчет весов"]:::process
    end

    %% --- Output ---
    subgraph Out ["5. Результат"]
        Edges[("graphs.edges")]:::graphData
    end

    Ways --> Split --> Filter
    Filter -->|"Ground"| Loop --> Node --> Snap --> Topo
    Filter -->|"Bridge"| Topo
    Topo --> Attrib --> Cost --> Edges
    Barriers -.->|"Update Cost"| Edges
