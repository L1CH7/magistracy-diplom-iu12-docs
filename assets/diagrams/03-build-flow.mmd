stateDiagram-v2
    direction TB

    %% Начальное состояние
    state "1. Сырые данные (OSM)" as Raw
    [*] --> Raw

    %% Блок Препроцессинга (Вставка в edge_candidates)
    state "2. Геометрический препроцессинг" as Prep {
        direction LR
        Segmentize: ST_Segmentize (50m)
        Subdivide: ST_Subdivide (Нарезка)
        Snap: ST_SnapToGrid (Привязка)
        
        Segmentize --> Subdivide
        Subdivide --> Snap
    }

    Raw --> Prep

    %% Развилка логики (Layer Logic)
    state "Тип объекта?" as LayerCheck

    Prep --> LayerCheck

    %% Ветка Земли (Сложная обработка)
    state "3A. Обработка земли (Grid Noding)" as Ground {
        direction LR
        GridLoop: Цикл по секторам
        Node: ST_Node (Поиск пересечений)
        dedup: Дедупликация
        
        GridLoop --> Node
        Node --> dedup
    }

    %% Ветка Мостов (Простая обработка)
    state "3B. Изолированный слой" as Bridge {
        Copy: Direct Copy (Без узлования)
        note right of Copy
            Мосты и тоннели
            не образуют
            перекрестков
        end note
    }

    %% Маршрутизация потоков
    LayerCheck --> Ground: Ground (Земля)
    LayerCheck --> Bridge: Isolated (Мосты)

    %% Финальная сборка
    state "4. Синтез графа" as Final {
        direction LR
        Merge: Слияние (Merge Tables)
        Topo: pgr_createTopology
        Physics: Расчет скоростей и весов
        
        Merge --> Topo
        Topo --> Physics
    }

    Ground --> Final
    Bridge --> Final

    %% Результат
    state "5. Готовый граф (graphs.edges)" as Result
    Final --> Result
    Result --> [*]