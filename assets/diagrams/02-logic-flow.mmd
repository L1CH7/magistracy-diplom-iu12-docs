%%{
  init: {
    "theme": "base",
    "themeVariables": {
      "fontSize": "24px",
      "fontFamily": "GOST2304 Type A",
      "lineColor": "#000000"
    },
    "flowchart": {
      "htmlLabels": true,
      "wrappingWidth": 200,
      "rankSpacing": 60,
      "padding": 5
    }
  }
}%%

flowchart TD
    %% --- СТИЛИ ---
    classDef rawData fill:#e1f7d5,stroke:#333,stroke-width:1px,shape:cylinder;
    classDef graphData fill:#d5e8f7,stroke:#005f9e,stroke-width:2px,shape:cylinder;
    classDef process fill:#fff0b3,stroke:#f39c12,stroke-width:2px,shape:rect,rx:5,ry:5;
    classDef action fill:#fff,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5,shape:hexagon;

    %% --- 1. ВХОДНЫЕ ДАННЫЕ ---
    subgraph Input ["1. Входной слой&nbsp;<br/>(Schema OSM)<br/>&nbsp;"]
        direction TB
        Ways[("osm.ways")]:::rawData
        Barriers[("osm.barriers")]:::rawData
        Restr[("osm.turn_restrictions")]:::rawData
    end

    %% --- 2. ПРЕДПОДГОТОВКА (Preprocessing) ---
    subgraph Prep ["2. Дискретизация&nbsp;<br/>(Preprocessing)<br/>&nbsp;"]
        Split["ST_Subdivide + ST_Segmentize<br/>(Max 500m segments)"]:::process
        Filter["Group Separation<br/>(Ground vs Bridges)"]:::process
    end

    %% --- 3. ГРИД-НОДИНГ (Core Build) ---
    subgraph GridNoding ["3. Сборка топологии<br/>(Grid-Based)"]
        GridLoop{{"Loop over 0.05° Tiles"}}:::process
        STNode["ST_Node (In-Memory per Tile)"]:::action
        SnapToGrid["ST_SnapToGrid (0.000001°)"]:::action
    end

    %% --- 4. СИНТЕЗ (Synthesis) ---
    subgraph Synthesis ["4. Генерация графа (Schema GRAPHS)"]
        direction TB
        pgrTopo["pgr_createTopology<br/>(Nodes Discovery)"]:::process
        AttribMap["Attribute Inheritance<br/>(Inherit tags from Ways)"]:::process
        CostCalc["Weight Matrix Calculation<br/>(Cost/Reverse_Cost)"]:::process
    end

    %% --- 5. РЕЗУЛЬТАТ ---
    subgraph Output ["5. Финальный граф"]
        Nodes[("graphs.nodes")]:::graphData
        Edges[("graphs.edges")]:::graphData
    end

    %% === ПОТОКИ ===
    Ways --> Split
    Split --> Filter
    
    Filter -->|"Ground Edges"| GridLoop
    GridLoop --> STNode
    STNode --> SnapToGrid
    SnapToGrid --> pgrTopo
    
    Filter -->|"Bridges (Bypass Noding)"| pgrTopo
    
    pgrTopo --> AttribMap
    AttribMap --> CostCalc
    
    CostCalc -->|Bulk Insert| Edges
    CostCalc -->|Bulk Insert| Nodes

    %% Внешнее влияние (Барьеры)
    Barriers -.->|"Spatial Update<br/>is_open = false"| Edges
    Restr -.->|"Logic Metadata<br/>for trsp"| Edges