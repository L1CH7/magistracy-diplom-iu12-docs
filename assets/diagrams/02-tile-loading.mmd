flowchart TD
    %% --- Styles ---
    classDef client fill:#f9f,stroke:#333;
    classDef logic fill:#fff0b3,stroke:#f39c12;
    classDef db fill:#d5e8f7,stroke:#005f9e;

    Start("Start: Receive BBO") --> Split["Split BBOX into 0.05 Tiles"]
    Split --> Check{"Check DB for Tiles"}
    
    Check -->|Exists & Valid| Skip[Skip Download]
    Check -->|Missing / Old| Queue["Add to Download Queue"]
    
    Queue --> Batch["Process Batch (Semaphore limit)"]
    Batch --> Request["Overpass API Request"]
    
    Request -- JSON --> Parse["Parse & Validate"]
    Parse --> Insert[("Bulk Insert into DB")]
    
    Insert --> UpdateStatus["Update Tile Status"]
    UpdateStatus --> Broadcast["WebSocket: Map Update"]

    Skip --> End(End)
    Broadcast --> End
